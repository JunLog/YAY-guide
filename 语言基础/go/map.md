# map

## mapæ¦‚è¦

Goè¯­è¨€ä¸­mapæ˜¯æ•£åˆ—è¡¨çš„å¼•ç”¨ã€‚æ•£åˆ—è¡¨å¯ä»¥ç”¨æ¥å­˜å‚¨é”®å€¼å¯¹å…ƒç´ ã€‚

mapç±»å‹æ˜¯map[k]vï¼Œå…¶ä¸­kæ˜¯å­—å…¸çš„é”®ï¼Œvæ˜¯å­—å…¸ä¸­å€¼å¯¹åº”çš„æ•°æ®ç±»å‹ã€‚

> ğŸ’¡:kçš„ç±»å‹å¿…é¡»æ˜¯å¯ä»¥é€šè¿‡æ“ä½œç¬¦==æ¥è¿›è¡Œæ¯”è¾ƒçš„æ•°æ®ç±»å‹ã€‚vçš„ç±»å‹åˆ™æ²¡æœ‰é™åˆ¶ã€‚

```go
var a map[string]string
```

mapç±»å‹çš„å˜é‡æœ¬è´¨ä¸Šæ˜¯ä¸ªæŒ‡é’ˆï¼Œè¿™äº›é”®å€¼å¯¹å®é™…ä¸Šæ˜¯é€šè¿‡å“ˆå¸Œè¡¨æ¥å­˜å‚¨çš„ã€‚

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029195933.webp)

> â“ï¼šä¸ºä»€ä¹ˆè¦ç”¨å“ˆå¸Œè¡¨ï¼Ÿ

èƒ½å¤Ÿå­˜å‚¨é”®å€¼å¯¹çš„æ•°æ®ç»“æ„æœ‰å¾ˆå¤šç§ï¼Œå¯ä»¥æ˜¯æ•°ç»„ï¼Œä¹Ÿå¯ä»¥æ˜¯é“¾è¡¨ï¼Œä½†æ˜¯èƒ½ç”¨ä¸ä»£è¡¨å¥½ç”¨ã€‚å¦‚æœæ¯æ¬¡æŸ¥æ‰¾ä¸€ä¸ªé”®éƒ½è¦ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹éå†ï¼Œç›´åˆ°å‘ç°åŒ¹é…çš„é”®æˆ–è€…éå†å®Œæ‰€æœ‰å…ƒç´ ï¼Œè¿™æ ·çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯O(n)ã€‚

æ•£åˆ—è¡¨çš„é›†åˆï¼Œé”®å€¼æ˜¯å”¯ä¸€çš„ï¼Œé”®å¯¹åº”çš„å€¼å¯ä»¥é€šè¿‡é”®æ¥è·å–ï¼Œæ›´æ–°æˆ–è€…åˆ é™¤ã€‚è¿™äº›æ“ä½œåŸºæœ¬ä¸Šé€šè¿‡å¸¸é‡æ—¶é—´é”®çš„æ¯”è¾ƒæ¥å®Œæˆï¼Œæ—¶é—´å¤æ‚åº¦å°±æ˜¯O(1)

## Hashmap

### å»ºè¡¨

å“ˆå¸Œè¡¨é€šå¸¸ä¼šæœ‰ä¸€å †æ¡¶(`bucket`)æ¥å­˜å‚¨é”®å€¼å¯¹ã€‚ç°åœ¨æœ‰ä¸€ä¸ªé”®å€¼å¯¹`{k,v}` ï¼Œé‚£ä¹ˆæ€ä¹ˆé€‰æ¡¶ï¼Ÿé€šè¿‡hashå‡½æ•°å°†kè½¬æ¢æˆhashå€¼ï¼Œé€šè¿‡hashä»æ¡¶çš„ç¼–å·è¿›è¡Œé€‰æ‹©ï¼Œä»è€Œé€šè¿‡`array[hash[key]]`å®ç°O(1)çš„æŸ¥æ‰¾æ•ˆç‡ã€‚

è¿™é‡Œæœ‰ä¸¤ç§æ–¹å¼æ¯”è¾ƒå¸¸ç”¨

1. å–æ¨¡è¿ç®— `hash%m`ï¼ˆé€šè¿‡hashå€¼ä¸æ¡¶çš„ä¸ªæ•°è¿›è¡Œå–æ¨¡å¾—åˆ°ç¼–å·ï¼‰
2. æŒ‰ä½ä¸è¿ç®— `  hash&(m-1)` (hashå€¼ä¸m-1è¿›è¡Œä¸è¿ç®—)

ç¬¬äºŒç§æ›´åŠ é«˜æ•ˆï¼Œä½†æ˜¯æœ‰ä¸€å®šçš„é™åˆ¶ã€‚

> â—ï¼šmå¿…é¡»è¦æ˜¯2çš„æ•´æ•°æ¬¡å¹‚è¿™æ ·æ‰èƒ½ä¿è¯ä¸è¿ç®—ç»“æœè½åœ¨[0,m-1]ï¼Œè€Œä¸ä¼šå‡ºç°æœ‰äº›æ¡¶æ³¨å®šä¸ä¼šè¢«é€‰ä¸­çš„æƒ…å†µã€‚
>
> å½“mæ˜¯5ï¼Œä»–çš„äºŒè¿›åˆ¶æ•°ä¸º`101` é‚£ä¹ˆm-1çš„äºŒè¿›åˆ¶æ•°ä¸º`100` ï¼Œæ— è®ºä»€ä¹ˆæ•°ä¸m-1è¿›è¡Œä¸è¿ç®—ï¼Œåé¢ä¸¤ä½éƒ½æ˜¯0ï¼Œå°±ä¼šå‡ºç°ç¼–å·[1,3]çš„æ¡¶æ³¨å®šä¸ä¼šè¢«é€‰ä¸­çš„æƒ…å†µã€‚
>
> ![image-20211028143533945](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211028143534.png)

å“ˆå¸Œå‡½æ•°çš„å®ç°æœ‰å¾ˆå¤šï¼Œå…¶ç›®çš„éƒ½æ˜¯è®©å“ˆå¸Œç»“æœèƒ½å¤Ÿå°½å¯èƒ½çš„å‡åŒ€åˆ†å¸ƒåœ¨`0~length(array)`é—´ã€‚

ä¸€ä¸ªå®Œç¾çš„å“ˆå¸Œå‡½æ•°å°±æ˜¯å°†`key`å’Œ`index`ä¸€ ä¸€å¯¹åº”ï¼›æ—¶é—´å¤æ‚åº¦ä¸ºO(1)

ä¸€ä¸ªæåçš„å“ˆå¸Œå‡½æ•°å°±æ˜¯å°†æ‰€æœ‰çš„`key`éƒ½æ˜ å°„åˆ°ä¸€ä¸ª`index`ä¸Šã€‚å¯èƒ½è¾¾åˆ°çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(n)

### å“ˆå¸Œå†²çª

å½“æˆ‘ä»¬å†æ¬¡å­˜ä¸€ä¸ªé”®å€¼å¯¹`{k2,v2}`æ—¶å€™ä»–çš„å“ˆå¸Œå€¼é€šè¿‡å“ˆå¸Œå‡½æ•°å¾—åˆ°æ¡¶çš„ç¼–å·ï¼Œæ¡¶é‡Œé¢å·²ç»æœ‰å­˜å‚¨äº†ä¸€ä¸ªé”®å€¼å¯¹ã€‚è¿™å°±æ˜¯å“ˆå¸Œå†²çªã€‚åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œå“ˆå¸Œå‡½æ•°è¾“å…¥çš„èŒƒå›´ä¸€å®šä¼šè¿œè¿œå¤§äºè¾“å‡ºçš„èŒƒå›´ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨å“ˆå¸Œè¡¨æ—¶ä¸€å®šä¼šé‡åˆ°å†²çªã€‚**é€šå¸¸æœ‰ä¸¤ä¸ªæ€è·¯æ¥è§£å†³ã€‚**

> ç¬¬ä¸€ç§ï¼šå¼€æ”¾åœ°å€æ³•

å‡è®¾æ­¤æ—¶éœ€è¦å­˜å‚¨çš„é”®å€¼å¯¹`{k2,v2}`å¯¹åº”çš„æ¡¶ç¼–å·1å·²ç»è¢«å ç”¨äº†ï¼Œé‚£ä¹ˆå°±ç”¨ä¸‹ä¸€ä¸ªç©ºé—²æ¡¶ç¼–å·3æ¥å­˜é”®å€¼å¯¹ã€‚

å½“æŸ¥æ‰¾`k2`æ—¶å€™ï¼Œæ ¹æ®å“ˆå¸Œå‡½æ•°å®šä½åˆ°ç¼–å·ä¸º1çš„æ¡¶ï¼Œä½†æ˜¯é€šè¿‡æ¯”è¾ƒå‘ç°keyä¸å¯¹ï¼Œé‚£ä¹ˆå°±ä¼šç»§ç»­æ£€æµ‹ä¸‹ä¸€ä¸ªæ¡¶ï¼Œç›´åˆ°åŒ¹é…æˆåŠŸæˆ–è€…é‡åˆ°ç©ºæ¡¶å°±ä»£è¡¨keyä¸å­˜åœ¨ã€‚

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029200029.webp)

> ç¬¬äºŒç§ï¼šæ‹‰é“¾æ³•ï¼ˆgoçš„mapå°±æ˜¯åˆ©ç”¨è¿™ç§æ–¹å¼è§£å†³ï¼‰

å‡è®¾æ­¤æ—¶éœ€è¦å­˜å‚¨çš„é”®å€¼å¯¹`{k2,v2}`å¯¹åº”çš„æ¡¶ç¼–å·1å·²ç»è¢«å ç”¨äº†ï¼Œé‚£ä¹ˆå°±åœ¨ç¼–å·ä¸º1çš„æ¡¶åé¢é“¾æ¥ä¸€ä¸ªæ¡¶å­˜å‚¨é”®å€¼å¯¹ã€‚æ­¤æ—¶çš„ç¼–å·1çš„æ¡¶è¿˜è¦é¢å¤–è®°å½•ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è¿åœ¨ä¸€èµ·æ¡¶ã€‚

å½“æŸ¥æ‰¾`k2`æ—¶å€™ï¼Œæ ¹æ®å“ˆå¸Œå‡½æ•°å®šä½åˆ°ç¼–å·ä¸º1çš„æ¡¶ï¼Œä½†æ˜¯é€šè¿‡æ¯”è¾ƒå‘ç°keyä¸å¯¹ï¼Œå°±ä¼šé€šè¿‡æŒ‡é’ˆå»æŸ¥è¯¢ï¼Œé€šè¿‡æ¯”è¾ƒkeyçš„å€¼æ¥é”å®šé”®å€¼å¯¹ã€‚

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029200111.webp)

> â—ï¼šå¦‚æœå“ˆå¸Œå‡½æ•°å¯ä»¥å¾ˆå‡åŒ€çš„æŠŠkeyæ˜ å°„åˆ°å„ä¸ªæ¡¶é‡Œï¼Œå‘ç”Ÿå“ˆå¸Œå†²çªçš„å‡ ç‡å°±ä¼šé™ä½ã€‚å“ˆå¸Œå†²çªä¼šå½±å“å“ˆå¸Œè¯»å†™çš„æ•ˆç‡ï¼Œé€‚å½“çš„å¯¹å“ˆå¸Œè¡¨çš„æ‰©å®¹ä¹Ÿæ˜¯ä¸€ä¸ªä¿éšœè¯»å†™æ•ˆç‡çš„æ‰‹æ®µä¹‹ä¸€ã€‚

### æ‰©å®¹

å…³äºæ‰©å®¹ï¼Œæˆ‘ä»¬è¦ææ¸…æ¥šä¸¤ç‚¹ï¼š

* ä½•æ—¶æ‰©å®¹ï¼Ÿ
* æ€ä¹ˆæ‰©å®¹ï¼Ÿ

> ä½•æ—¶æ‰©å®¹ï¼Ÿ

å“ˆå¸Œè¡¨ä¸­å­˜å‚¨çš„é”®å€¼å¯¹æ•°é‡å’Œæ¡¶æ•°é‡çš„æ¯”å€¼ä¼šä½œä¸ºåˆ¤æ–­å“ˆå¸Œè¡¨æ˜¯å¦éœ€è¦æ‰©å®¹çš„ä¾æ®ï¼Œè¿™ä¸ªä¾æ®å«åš**è´Ÿè½½å› å­**ï¼ˆLoad Factorï¼‰é€šå¸¸éœ€è¦è®¾å®šä¸€ä¸ªè§¦å‘æ‰©å®¹çš„æœ€å¤§è´Ÿè½½å› å­ã€‚

  `loadFactor = keyCount / bucketCount`

> æ€ä¹ˆæ‰©å®¹ï¼Ÿ

éœ€è¦æ‰©å®¹æ—¶å€™ï¼Œå°±ä¼šåˆ†é…æ›´å¤šçš„æ¡¶ä½œä¸ºæ–°æ¡¶ï¼Œæ­¤æ—¶éœ€è¦æŠŠæ—§æ¡¶çš„å€¼éƒ½è¿ç§»åˆ°æ–°æ¡¶ä¸­ï¼Œå¦‚æœä¸€æ¬¡æ€§æŠŠæ‰€æœ‰é”®å€¼å¯¹æŒªåˆ°æ–°çš„æ¡¶é‡Œï¼Œé‚£ä¹ˆå¯¹äºé”®å€¼å¯¹æ•°é‡å¾ˆå¤šæƒ…å†µï¼Œæ¯æ¬¡æ‰©å®¹å ç”¨çš„æ—¶é—´å¤ªé•¿å°±ä¼šé€ æˆæ€§èƒ½ç¬æ—¶æ˜æ˜¾æŠ–åŠ¨ï¼Œæ‰€ä»¥é€šå¸¸ä¼šé€‰æ‹©**â€œæ¸è¿›å¼æ‰©å®¹â€**ã€‚

ä¸€ä¸ªå­—æ®µï¼ˆoldbuckets ï¼‰è®°å½•æ—§æ¡¶çš„ä½ç½®ï¼Œä¸€ä¸ªå­—æ®µï¼ˆnevacuate ï¼‰è®°å½•æ—§æ¡¶è¿ç§»çš„è¿›åº¦ã€‚å½“éœ€è¦æ‰©å®¹æ—¶å€™ï¼Œä¼šåˆ†é…è¶³å¤Ÿå¤šçš„æ–°æ¡¶ï¼Œåœ¨æ¯æ¬¡å“ˆå¸Œè¡¨è¯»å†™æ“ä½œï¼Œæ£€æµ‹å½“å½“å‰å¤„äºè¿ç§»é˜¶æ®µï¼Œå°±è¿ç§»ä¸€éƒ¨åˆ†é”®å€¼å¯¹åˆ°æ–°æ¡¶é‡Œï¼Œç›´åˆ°æ‰€æœ‰æ•°æ®è¿ç§»æˆåŠŸã€‚

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029200131.webp)

## Goä¸­çš„map

mapç±»å‹çš„å˜é‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªhmapç±»å‹çš„æŒ‡é’ˆï¼š

```go

type hmap struct {
    count     int    //å·²ç»å­˜å‚¨çš„é”®å€¼å¯¹ä¸ªæ•°
    flags     uint8
    B         uint8  // å¸¸è§„æ¡¶ä¸ªæ•°ç­‰äº2^B,é€‰æ‹©æ¡¶ç”¨çš„æ˜¯ä¸è¿ç®—
    noverflow uint16 // ä½¿ç”¨çš„æº¢å‡ºæ¡¶æ•°é‡
    hash0     uint32 // hash seed
    buckets    unsafe.Pointer // å¸¸è§„æ¡¶èµ·å§‹åœ°å€
    oldbuckets unsafe.Pointer // æ‰©å®¹æ—¶ä¿å­˜åŸæ¥å¸¸è§„æ¡¶çš„åœ°å€
    nevacuate  uintptr        // æ¸è¿›å¼æ‰©å®¹æ—¶è®°å½•ä¸‹ä¸€ä¸ªè¦è¢«è¿ç§»çš„æ—§æ¡¶ç¼–å·

    extra *mapextra //é‡Œé¢è®°å½•çš„éƒ½æ˜¯æº¢å‡ºæ¡¶ç›¸å…³çš„ä¿¡æ¯ï¼š
}
```

### bmap

`map`ä½¿ç”¨çš„æ¡¶å¾ˆæœ‰è®¾è®¡æ„Ÿï¼Œæ¯ä¸ªæ¡¶é‡Œå¯ä»¥å­˜å‚¨8ä¸ªé”®å€¼å¯¹ï¼Œå¹¶ä¸”ä¸ºäº†å†…å­˜ä½¿ç”¨æ›´åŠ ç´§å‡‘ï¼Œ8ä¸ªé”®æ”¾ä¸€èµ·ï¼Œ8ä¸ªå€¼æ”¾ä¸€èµ·ã€‚å¯¹åº”æ¯ä¸ª`key`åªä¿å­˜å…¶å“ˆå¸Œå€¼çš„é«˜8ä½ï¼ˆ`tophash`ï¼‰ã€‚è€Œæ¯ä¸ªé”®å€¼å¯¹çš„`tophash`ã€`key`å’Œ`value`çš„ç´¢å¼•é¡ºåºä¸€ä¸€å¯¹åº”ã€‚è¿™å°±æ˜¯`map`ä½¿ç”¨çš„æ¡¶çš„å†…å­˜å¸ƒå±€ã€‚

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029195952.webp)

æ—¢ç„¶æ¯ä¸ªæ¡¶é‡Œå¯ä»¥å­˜å‚¨8ä¸ªå…ƒç´ ï¼Œé‚£å­˜æ»¡äº†æ€ä¹ˆåŠï¼Ÿæ‰©å®¹çš„ä»£ä»·è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œæ‰€ä»¥ä¸ºäº†å‡å°‘æ‰©å®¹æ¬¡æ•°ï¼Œè¿™é‡Œå¼•å…¥äº†**æº¢å‡ºæ¡¶(overflow)**ã€‚æº¢å‡ºæ¡¶çš„å†…å­˜å¸ƒå±€ä¸ä¹‹å‰ä»‹ç»çš„**å¸¸è§„æ¡¶**ç›¸åŒã€‚å¦‚æœå“ˆå¸Œè¡¨è¦åˆ†é…çš„æ¡¶çš„æ•°ç›®å¤§äº2^4ï¼Œå°±ä¼šé¢„åˆ†é…2^(B-4)ä¸ªæº¢å‡ºæ¡¶å¤‡ç”¨ã€‚è¿™äº›å¸¸è§„æ¡¶å’Œæº¢å‡ºæ¡¶åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ï¼Œåªæ˜¯å‰2^Bä¸ªç”¨ä½œå¸¸è§„æ¡¶ï¼Œåé¢çš„ç”¨ä½œæº¢å‡ºæ¡¶ã€‚

```go
//æº¢å‡ºæ¡¶ç›¸å…³çš„ä¿¡æ¯
type mapextra struct {
    overflow    *[]*bmap //æŠŠå·²ç»ç”¨åˆ°çš„æº¢å‡ºæ¡¶é“¾èµ·æ¥
    oldoverflow *[]*bmap //æ¸è¿›å¼æ‰©å®¹æ—¶ï¼Œä¿å­˜æ—§æ¡¶ç”¨åˆ°çš„æº¢å‡ºæ¡¶
    nextOverflow *bmap   //ä¸‹ä¸€ä¸ªå°šæœªä½¿ç”¨çš„æº¢å‡ºæ¡¶
}
```

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029200142.webp)

å¦‚æœå½“å‰æ¡¶å­˜æ»¡äº†ä»¥åï¼Œæ£€æŸ¥`hmap.extra.nextoverflow`ï¼Œå¦‚æœè¿˜æœ‰å¯ç”¨çš„æº¢å‡ºæ¡¶ï¼Œå°±åœ¨è¿™ä¸ªæ¡¶åé¢é“¾ä¸Šè¿™ä¸ªæº¢å‡ºæ¡¶ï¼Œç„¶åç»§ç»­å¾€è¿™ä¸ªæº¢å‡ºæ¡¶é‡Œå­˜ã€‚è€Œ`hmap.extra.nextoverflow`ç»§ç»­æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„æº¢å‡ºæ¡¶ã€‚

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029200150.webp)

å¦‚æœæˆ‘ä»¬æŠŠå“ˆå¸Œè¡¨çš„æ¡¶å­˜æ»¡äº†ï¼Œé‚£ä¹ˆç°åœ¨å†ç»§ç»­å­˜å‚¨é”®å€¼å¯¹ï¼Œé‚£ä¹ˆè¿™ä¸ªå“ˆå¸Œè¡¨ä¼šåˆ›å»ºæº¢å‡ºæ¡¶è¿˜æ˜¯å‘ç”Ÿæ‰©å®¹å‘¢ï¼Ÿ

### æ‰©å®¹è§„åˆ™

> ç¿»å€æ‰©å®¹

goè¯­è¨€ä¸­`map`è´Ÿè½½å› å­é»˜è®¤æ˜¯`6.5`ï¼Œå½“æ¯”å€¼è¶…è¿‡è´Ÿè½½å› å­å°±ä¼šè§¦å‘**ç¿»å€æ‰©å®¹**ã€‚

` hmap.count / 2^hmap.B > 6.5`

åˆ†é…æ–°æ¡¶æ•°ç›®æ˜¯æ—§æ¡¶çš„2å€ï¼Œ`hmap.oldbuckets`æŒ‡å‘æ—§æ¡¶ï¼Œ`hmap.buckets`æŒ‡å‘æ–°æ¡¶ã€‚`hmap.nevacuate`ä¸º0ï¼Œè¡¨ç¤ºæ¥ä¸‹æ¥è¦è¿ç§»ç¼–å·ä¸º0çš„æ—§æ¡¶ã€‚

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029200157.webp)

ä¾‹å¦‚ï¼šå°†æ—§æ¡¶æ•°é‡è®°ä¸ºm=4ï¼Œæ–°æ¡¶æ•°é‡å°±æ˜¯2m=8ï¼Œå¦‚æœä¸€ä¸ªå“ˆå¸Œå€¼é€‰æ‹©0å·æ—§æ¡¶ï¼šh&(m-1)=0ï¼Œé‚£ä¹ˆhçš„äºŒè¿›åˆ¶æœ€ä½ä¸¤ä½ä¸€å®šä¸º0(`xxxxxx00`)ï¼Œå¯¹äºæ–°æ¡¶ï¼Œå¦‚æœç¬¬ä¸‰ä½æ˜¯1çš„è¯ï¼Œå°±å»ç¼–å·ä¸º4çš„æ¡¶ï¼Œå¦‚æœä¸º0çš„è¯å°±å»ç¼–å·ä¸º0çš„æ¡¶ã€‚æ¯ä¸ªæ—§æ¡¶çš„é”®å€¼å¯¹éƒ½ä¼šåˆ†æµåˆ°ä¸¤ä¸ªæ–°æ¡¶ä¸­ã€‚

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029200203.webp)

ç¼–å·ä¸º`hmap.nevacuate`çš„æ—§æ¡¶è¿ç§»ç»“æŸåä¼šå¢åŠ è¿™ä¸ªç¼–å·å€¼ï¼Œç›´åˆ°æ‰€æœ‰æ—§æ¡¶è¿ç§»å®Œæ¯•ï¼ŒæŠŠ`hmap.oldbuckets`ç½®ä¸ºnilï¼Œä¸€æ¬¡ç¿»å€æ‰©å®¹ç»“æŸã€‚

> ç­‰é‡æ‰©å®¹

å¦‚æœæ²¡æœ‰è¶…è¿‡è®¾ç½®çš„è´Ÿè½½å› å­ä¸Šé™ï¼Œä½†æ˜¯ä½¿ç”¨çš„æº¢å‡ºæ¡¶è¾ƒå¤šï¼Œä¹Ÿä¼šè§¦å‘æ‰©å®¹ï¼Œä¸è¿‡è¿™ä¸€æ¬¡æ˜¯**ç­‰é‡æ‰©å®¹**ã€‚

**ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šç”¨å¤šå°‘æº¢å‡ºæ¡¶ç®—å¤šï¼Ÿ**

1. å¦‚æœå¸¸è§„æ¡¶æ•°ç›®ä¸å¤§äº`2^15`ï¼Œé‚£ä¹ˆä½¿ç”¨çš„æº¢å‡ºæ¡¶æ•°ç›®è¶…è¿‡å¸¸è§„æ¡¶å°±ç®—æ˜¯å¤šäº†ï¼›
2. å¦‚æœå¸¸è§„æ¡¶æ•°ç›®å¤§äº`2^ 15`ï¼Œé‚£ä¹ˆä½¿ç”¨æº¢å‡ºæ¡¶æ•°ç›®ä¸€æ—¦è¶…è¿‡`2^15`å°±ç®—å¤šäº†ã€‚

**ç¬¬äºŒä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆè¦ç­‰é‡æ‰©å®¹ï¼Ÿ**

åœ¨å¾ˆå¤šé”®å€¼å¯¹è¢«åˆ é™¤çš„æƒ…å†µä¸‹ï¼Œæ¡¶çš„è´Ÿè½½å› å­æ²¡æœ‰è¶…è¿‡ä¸Šé™å€¼ï¼Œå´ååä½¿ç”¨äº†å¾ˆå¤šæº¢å‡ºæ¡¶ã€‚

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029200217.webp)

è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæŠŠè¿™äº›é”®å€¼å¯¹é‡æ–°å®‰æ’åˆ°ç­‰é‡çš„æ–°æ¡¶ä¸­ï¼Œè™½ç„¶å“ˆå¸Œå€¼æ²¡å˜ï¼Œå¸¸è§„æ¡¶æ•°ç›®æ²¡å˜ï¼Œæ¯ä¸ªé”®å€¼å¯¹è¿˜æ˜¯ä¼šé€‰æ‹©ä¸æ—§æ¡¶ä¸€æ ·çš„æ–°æ¡¶ç¼–å·ï¼Œä½†æ˜¯èƒ½å¤Ÿå­˜å‚¨çš„æ›´åŠ ç´§å‡‘ï¼Œè¿›è€Œå‡å°‘æº¢å‡ºæ¡¶çš„ä½¿ç”¨ã€‚

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029200224.webp)

## å¸¸è§é—®é¢˜

> 1. mapæ¯æ¬¡éå†çš„é¡ºåºéƒ½æ˜¯ä¸åŒçš„ã€‚

ä¸ºäº†é˜²æ­¢å¼€å‘äººå‘˜ä¾èµ–mapçš„é¡ºåºï¼Œå¯¹äºæ¯ä¸€æ¬¡mapéå†ï¼ˆ`range`ï¼‰ï¼Œå¾—åˆ°ç»“æœçš„é¡ºåºéƒ½æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºåœ¨åˆå§‹åŒ–è¿­ä»£å™¨ï¼ˆ`runtime.mapiterinit`ï¼‰æ—¶éƒ½å¯¹`startBucket`å’Œ`startCell`è¿›è¡Œäº†`random`æ“ä½œã€‚

```go
func mapiterinit(t *maptype, h *hmap, it *hiter) {

   //some code ...

   // decide where to start

   r := uintptr(fastrand()) //fastrand æ˜¯ä¸€ä¸ªå¿«é€Ÿç”Ÿæˆéšæœºæ•°çš„å‡½æ•°

   if h.B > 31-bucketCntBits {

      r += uintptr(fastrand()) << 31

   }

   it.startBucket = r & bucketMask(h.B) 

   //bucketMaskè¿”å›bucketçš„ä¸ªæ•°-1ï¼Œä¹Ÿå°±æ˜¯å…¨1ï¼Œå°†rå’ŒbucketMaskåšä¸æ“ä½œï¼Œè·å¾—å¼€å§‹çš„æ¡¶ç¼–å·

   it.offset = uint8(r >> h.B & (bucketCnt - 1))

   //bucketCntæ˜¯å¸¸é‡8ä»£è¡¨ä¸€ä¸ªæ¡¶å†…çš„cellæ•°ï¼Œå°†rå³ç§»Bä½åä¸7åšä¸è¿ç®—ï¼Œå¯ä»¥è·å¾—å¼€å§‹çš„cellç¼–å·

   //some code ...

}

```

> 2. kçš„ç±»å‹å¿…é¡»æ˜¯å¯ä»¥é€šè¿‡æ“ä½œç¬¦==æ¥è¿›è¡Œæ¯”è¾ƒçš„æ•°æ®ç±»å‹

å®`Go`è¯­è¨€ä¸­æ¯ç§ç±»å‹éƒ½æœ‰å¯¹åº”çš„ç±»å‹å…ƒæ•°æ®ï¼Œç±»å‹å…ƒæ•°æ®éƒ½æœ‰ä¸€ä¸ªç›¸åŒçš„`Header`ï¼Œå°±æ˜¯`runtime._type`ã€‚è€Œåœ¨`_type.alg`è¿™é‡Œè®°å½•äº†è¯¥ç±»å‹çš„ä¸¤ä¸ªå‡½æ•°ï¼š`hash`å’Œ`equal`ã€‚

```go
type typeAlg struct {
    hash  func(unsafe.Pointer, uintptr) uintptr
    equal func(unsafe.Pointer, unsafe.Pointer) bool
}
```

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211029200230.webp)

sliceã€function valueã€mapæ˜¯ä¸å¯æ¯”è¾ƒçš„(ä½†æ˜¯è¿™ä¸‰ç§ç±»å‹éƒ½å¯ä»¥å’Œnilè¿›è¡Œå¯¹æ¯”)

> 3. ä¸å¯å¯»å€

æ­£æ˜¯å› ä¸ºæ‰©å®¹è¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿé”®å€¼å¯¹è¿ç§»ï¼Œé”®å€¼å¯¹çš„åœ°å€ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥æ‰è¯´mapçš„å…ƒç´ æ˜¯**ä¸å¯å¯»å€**çš„ï¼Œå¦‚æœè¦å–ä¸€ä¸ªvalueçš„åœ°å€åˆ™**ä¸èƒ½é€šè¿‡ç¼–è¯‘**ã€‚

> 4.mapä¸æ”¯æŒå¹¶å‘è¯»å†™ï¼Œåªèƒ½å¹¶å‘è¯»

## æ€»ç»“

Goè¯­è¨€ä¸­çš„mapé€šè¿‡**ä¸è¿ç®—**æ‰¾æ¡¶çš„ç¼–å·ï¼Œå‘ç”Ÿ**å“ˆå¸Œå†²çª**æ—¶å€™ï¼Œé‡‡ç”¨**æ‹‰é“¾æ³•**è§£å†³ï¼Œå½“**è´Ÿè½½å› å­**è¶…è¿‡`6.5`æ—¶å€™ï¼Œå‘ç”Ÿ**ç¿»å€æ‰©å®¹**ï¼Œå¦‚æœæº¢å‡ºæ¡¶æ•°é‡è¿‡å¤šï¼Œé‚£ä¹ˆé‡‡ç”¨**ç­‰é‡æ‰©å®¹**ã€‚é‡‡ç”¨**æ¸è¿›å¼**è¿ç§»æ—§æ¡¶é”®å€¼å¯¹ã€‚

## ä½¿ç”¨æ³¨æ„

```go
func main(){
	find:=map[int]int{}
	find[1]=0
	idx:=0
    //åœ¨è¿™é‡Œçš„çŸ­å˜é‡å£°æ˜ï¼Œä¸ä¼šå¯¹ idx è¿›è¡Œèµ‹å€¼å¤„ç†ï¼Œè€Œæ˜¯é‡æ–°å£°æ˜å€¼ã€‚æ³¨æ„æ³¨æ„ï¼
	if idx,ok:=find[1];!ok {
		println(111)
	}
	println(idx)
}
```



## å‚è€ƒæ–‡ç« 

 [ã€Golangã€‘å›¾è§£map](https://mp.weixin.qq.com/s/0sjLD4_12Ql0QeWsO_A5pQ) 

[ã€æ·±åº¦è§£ægolang mapã€‘](https://juejin.cn/post/6954707500151078919#heading-4)

[[ç”±æµ…åˆ°æ·±ï¼Œå…¥é—¨Goè¯­è¨€Mapå®ç°åŸç†](https://segmentfault.com/a/1190000039101378)](https://segmentfault.com/a/1190000039101378)

[golangä¸­mapåº•å±‚Bå€¼çš„è®¡ç®—é€»è¾‘](https://zhuanlan.zhihu.com/p/366472077)

