# context的基本使用

## 如何使用上下文变量

### 一、结构定义

上下文对象存储一些共享的变量。这些变量通常使用结构化的对象来存储，以方便维护。

```go
// ==========================================================================
// This is auto-generated by gf cli tool. Fill this file as you wish.
// ==========================================================================

package model

import (
	"github.com/gogf/gf/net/ghttp"
)

const (
	// 上下文变量存储键名
	ContextKey = "ContextKey"
)

// 请求上下文结构
type Context struct {
	Session *ghttp.Session // 当前Session管理对象
	User    *ContextUser   // 上下文用户信息
}

// 请求上下文中的用户信息
type ContextUser struct {
	Id       uint   // 用户ID
	Passport string // 用户账号
	Nickname string // 用户名称
}

```

### 二、逻辑封装

上下文对象一般作用于业务逻辑，在`service`层将上下文变量相关的方法封装起来，方便其他模块使用

```go
package service

import (
	"context"
	"github.com/gogf/gf-demos/app/model"
	"github.com/gogf/gf/net/ghttp"
)

// 上下文管理服务
var Context = contextService{}

type contextService struct{}

// 初始化上下文对象指针到上下文对象中，以便后续的请求流程中可以修改。
func (s *contextService) Init(r *ghttp.Request, customCtx *model.Context) {
	r.SetCtxVar(model.ContextKey, customCtx)
}

// 获得上下文变量，如果没有设置，那么返回nil
func (s *contextService) Get(ctx context.Context) *model.Context {
	value := ctx.Value(model.ContextKey)
	if value == nil {
		return nil
	}
	//进行断言，判断是否能获取到请求的上下文
	if localCtx, ok := value.(*model.Context); ok {
		return localCtx
	}
	return nil
}

// 将上下文信息设置到上下文请求中，注意是完整覆盖
func (s *contextService) SetUser(ctx context.Context, ctxUser *model.ContextUser) {
	s.Get(ctx).User = ctxUser
}

```

### 三、上下文变量注入

每次请求需要用到上下文变量，那么一开始应该将上下文变量注入到请求流程中，方便请求函数进行使用。在这里我们采用**前置中间件**来实现。

```go
// 中间件管理服务
var Middleware = middlewareService{}

type middlewareService struct{}

// 自定义上下文对象
func (s *middlewareService) Ctx(r *ghttp.Request) {
	// 初始化，务必最开始执行
    //创建一个初始的session对象，会获取浏览器的sessionid
	customCtx := &model.Context{
		Session: r.Session,
	}
	//初始化context值
	Context.Init(r, customCtx)
	//如果之前进行登录，能获取到用户信息
    //流程：先查询本地的session的值，是否存储信息，如果存储了，那么将信息给到上下文变量。
    //此例子的session没有经过配置，默认存储在本地
	if user := Session.GetUser(r.Context()); user != nil {
		//获取用户信息
		customCtx.User = &model.ContextUser{
			Id:       user.Id,
			Passport: user.Passport,
			Nickname: user.Nickname,
		}
	}
	// 执行下一步请求逻辑
	r.Middleware.Next()
}
```

该中间件初始化了用户执行流程共享的对象，并且存储到`context.Context`变量中的对象是指针类型`*model.Context`。这样任何一个地方获取到这个指针，既可以获取到里面的数据，也能够直接修改里面的数据。

其中，如果`Session`中存在用户登录后的存储信息，那么也会将需要共享的用户基本信息写入到`*model.Context`中。

![image-20211006184725415](C:/Users/Y/AppData/Roaming/Typora/typora-user-images/image-20211006184725415.png)

![image-20211006184801240](https://cdn.jsdelivr.net/gh/baici1/image-host/newimg/20211006184801.png)

### 四、上下文变量使用

```go
// 用户注销
func (s *userService) SignOut(ctx context.Context) error {
	return Session.RemoveUser(ctx)
}
```